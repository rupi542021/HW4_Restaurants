<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <script src="../Scripts/ajaxCalls.js"></script>
    <script src="../Scripts/jquery-3.4.1.min.js"></script>
    <script src="../Scripts/bootstrap.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <link href="StyleSheet.css" rel="stylesheet" />
    <script>
        $(document).ready(function () {
            if (localStorage.getItem("loggedIn") != "") {
                let str = `<a href="Choose Highlights.html" class="btn btn-info btn-lg myButtonadd" id="btnEditP">
                            <span class="glyphicon glyphicon-pencil"></span> Edit Preferences                               
                          </a>`;
                $("#ph1").html(str);
            }
            $("#btnSignout").click(function () {
                localStorage.removeItem("loggedIn");
            });
            $(".cuisine_btn").click(function () {
                
                cusineId = this.id;
                if (localStorage.getItem("loggedIn") == "") {
                    pr = 0;
                    hlist = null;
                }
                else {
                    customerIn = JSON.parse(localStorage.getItem("loggedIn"));
                    pr = customerIn.PriceRange;
                    if (customerIn.Chlist.length == 0)
                        hlist = null;
                    else
                       hlist = customerIn.Chlist;
                }
                ajaxCall("GET", "../api/businesses/getRestCamp/" + cusineId , "", getCampSuccess, getCampError);
                
            });

        });
        function getCampSuccess(camps) {
            console.log(camps);
            renderHeader(camps);
            renderRest(camps);
            let api = "../api/businesses/" + cusineId + "/" + pr + "/" + hlist;
            console.log(api);
            ajaxCall("GET", api, "", getFSuccess, getFError);

            for (var i = 0; i < camps.length; i++) {
                let restId2Update = camps[i].Id;
                let mode = "view";
                ajaxCall("PUT", "../api/Campaigns/" + mode +"/" + restId2Update,"", updateSuccess, updateError);
            }
        }
        function updateSuccess(data) {
            console.log("the camp views updated")
            console.log(data);
        }
        function updateError(err) {
            console.log(err);
        }
        function getCampError(err) {
            console.log(err);
        }
            //function getFSuccess(data) {
            //    console.log(cusineId);
            //    console.log(data);
            //    customerIn = JSON.parse(localStorage.getItem("loggedIn"));
            //    if (customerIn.Chlist.length>0) {
            //        restaurantsByHArr = [];
            //        console.log(customerIn.Chlist);
            //        for (var i = 0; i < customerIn.Chlist.length; i++) {
            //            for (var j = 0; j < data.length; j++) {
            //              //  console.log(data[j].Highlights);
            //                if (data[j].Highlights.includes(customerIn.Chlist[i])) {
            //                    restaurantsByHArr.push(data[j]);
            //                   // if (!restaurantsByHArr.Contain(data[j])) { restaurantsByHArr.push(data[j])};
            //                }
            //            }
            //        }
            //    }
            //    else { restaurantsByHArr = data }
            //    console.log(restaurantsByHArr);
            //    if (customerIn.PriceRange != 0) {
            //        datafilteredByPR = restaurantsByHArr.filter((res) => res.PriceRange == customerIn.PriceRange);
            //        console.log(datafilteredByPR);
            //        datafiltered = datafilteredByPR.filter((res) => res.CuisineId == cusineId);
            //    }
                
            //    else {
            //        datafiltered = restaurantsByHArr.filter((res) => res.CuisineId == cusineId);
                   
            //    }
            //    console.log(datafiltered);
            //    render(datafiltered);
            //}

        function getFSuccess(data) {
            console.log(data);
            renderRest(data);
            let str = `</table></div>`;
            $("#ph2").append(str);
        }
        function renderHeader(arr) {
            let str = "";
            if (arr.length == 0) {
                str = `<br/><br/><br/><h2>There is no restaurants to display...</h2><h3>You can change your preferences and try again</h3>`;
            }
            else {
                str = `<div><table><tr>
                                                    <td><h3>Image</h3></td>
                                                    <td><h3>ID</h3></td>
                                                    <td><h3>Name</h3></td>
                                                    <td><h3>Rating</h3></td>
                                                    <td><h3>Category</h3></td>
                                                    <td><h3>Price Range</h3></td>
                                                    <td><h3>Phone number</h3></td>
                                                    <td><h3>Address</h3></td>
                                                    <td><h3>Highlights</h3></td>
                                             </tr>`;

            }
            $("#ph2").html(str);
        }
        function renderRest(arr) {
            let str = "";
                for (var i = 0; i < arr.length; i++) {
                    str += `<tr>`
                    if (arr[i].Image == "") {
                        str += `<td><a href = "` + arr[i].Url + `" >
                                <img src="default.jpg" onclick="UpdateClick(` + arr[i].Id +`)"></a></td>`
                    }
                    else {
                        str += `<td><a href = "` + arr[i].Url + `" >
                                <img src="`+ arr[i].Image + `" onclick="UpdateClick(` + arr[i].Id+`)"></a></td>`
                    }
                    str += `<td>` + arr[i].Id + `</td>
                                                                <td>` + arr[i].Name + `</td>
                                                                <td>` + arr[i].Reating + `</td >
                                                                <td>` + arr[i].Category + `</td>
                                                                <td>` + arr[i].PriceRange + `</td>
                                                                <td>` + arr[i].Phone + `</td >
                                                                <td>` + arr[i].Address + `</td>
                                                                <td>` + arr[i].Highlights.toString() + `</td>
                                                            </tr>`
                }
                $("#ph2").append(str);
            }

            function getFError(data) {
                alert("err");
                console.log(data);
            }
        function UpdateClick(restid2updateclick){
            let mode = "click";
            console.log(mode);
            ajaxCall("PUT", "../api/Campaigns/" + mode + "/" + restid2updateclick, "", updateSuccess, updateError);
        }
    </script>
</head>
<body>
    <div>
        <a href="Login.html" class="btn btn-info btn-lg myButtonadd" id="btnSignout">
            <span class="glyphicon glyphicon-log-out"></span> Log out
        </a>
        <a href="Admin.html" class="btn btn-info btn-lg myButtonadd">
            <span class="glyphicon glyphicon-log-out"></span> Admin Page
        </a>
        <div id="ph1"></div>
        <div>
            <br><h1>Choose cuisine in NYC</h1>
            <button id="1" class="myButton cuisine_btn">American</button>
            <button id="30" class="myButton cuisine_btn">Cafe</button>
            <button id="40" class="myButton cuisine_btn">Fast food</button>
            <button id="82" class="myButton cuisine_btn">Pizza</button>
            <button id="141" class="myButton cuisine_btn">Steak</button>
            <button id="177" class="myButton cuisine_btn">Sushi</button>
        </div>
        <br />
        <div id="ph2"></div>
    </div>

</body>
</html>