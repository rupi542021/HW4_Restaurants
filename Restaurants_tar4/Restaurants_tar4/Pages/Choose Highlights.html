<!DOCTYPE html>
<html>
<head>
    <script src="../Scripts/ajaxCalls.js"></script>
    <script src="../Scripts/jquery-3.4.1.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="../Scripts/bootstrap.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <link href="StyleSheet.css" rel="stylesheet" />

    <meta charset="utf-8" />
    <title></title>
    <script>

        $(document).ready(function () {
            hArr = ["Wifi", "Serves Alcohol", "Breakfast", "Dinner", "Lunch", "Vegetarian Friendly", "Takeaway Available", "Credit Card", "Delivery", "Cash"];
            if (localStorage.getItem("loggedIn") == "") {
                customerHighlight = [];
                customerParse = JSON.parse(localStorage.getItem("customer"));
                console.log(customerParse);

                let str = `<ul>
                    <li><a>Customer Highlights   </a></li>
                    <li style="float:right">
                        <a class="active" href="customerForm.html">
                            <span class="glyphicon glyphicon-circle-arrow-left"></span> Back</a></li>
                </ul><br />`
                document.getElementById("backbtn").innerHTML = str;
                renderAllHighlights(hArr);         
               
            }
            else {
                let str1 = `<ul>
                    <li><a>Customer Highlights   </a></li>
                    <li style="float:right">
                        <a class="active" href="Favorites.html">
                            <span class="glyphicon glyphicon-circle-arrow-right"></span> Back</a></li>
                </ul><br />`
                document.getElementById("backbtn").innerHTML = str1;

                customerIn = JSON.parse(localStorage.getItem("loggedIn"));
                customerHighlight = customerIn.Chlist;
                selectedRadio = customerIn.PriceRange;
                let str =`            <div>
                <p>Please select your price range:</p>
                <input type="radio" id="1" value="1" name="pr" onchange="radioPrice(this)" /><label>1</label>
                <input type="radio" id="2" value="2" name="pr" onchange="radioPrice(this)" /><label>2</label>
                <input type="radio" id="3" value="3" name="pr" onchange="radioPrice(this)" /><label>3</label>
                <input type="radio" id="4" value="4" name="pr" onchange="radioPrice(this)" /><label>4</label>
                <input type="radio" id="5" value="5" name="pr" onchange="radioPrice(this)" /><label>5</label>
            </div>
            <br />`
                document.getElementById("prUpdate").innerHTML = str;
                renderUserHighlights(hArr);
            }            
        });

        function renderUserHighlights(hArr) {
            customerIn = JSON.parse(localStorage.getItem("loggedIn"));
            console.log(customerIn);
            chlist = customerIn.Chlist;
            
            let str = "";
            for (var i = 0; i < hArr.length; i++) {
                if (chlist.includes(hArr[i])) {
                    str += `<input type="checkbox" id='` + hArr[i] + `' value='` + hArr[i] + `' checked onchange='cbxHighlight(this)'>
                       <label>`+ hArr[i] + `</label><br>`
                }
                    else {
                        str += `<input type="checkbox" id='` + hArr[i] + `' value='` + hArr[i] + `'onchange='cbxHighlight(this)'>
                       <label>`+ hArr[i] + `</label><br>`
                    }
                }
            document.getElementById("highlightsDIV").innerHTML = str;
        }

        function renderAllHighlights(hArr) {
            let str = "";

            for (var i = 0; i < hArr.length; i++) {
                str += `<input type="checkbox" id='` + hArr[i] + `' value='` + hArr[i] + `'onchange='cbxHighlight(this)'>
                       <label>`+ hArr[i] + `</label><br>`
            }
            document.getElementById("highlightsDIV").innerHTML = str;
        }

        function cbxHighlight(cbx) {
            console.log(cbx.id);
            console.log(cbx.checked);
            if (cbx.checked) {
                customerHighlight.push(cbx.id);
                console.log(customerHighlight);
            }
            else {
                customerHighlight = customerHighlight.filter((item) => item !== cbx.id);
                console.log(customerHighlight);
            }
        }

        function btnPostHighlight(){
            if (localStorage.getItem("loggedIn") == "") {
                customerParse.ChList = customerHighlight;
                console.log(customerParse);
                ajaxCall("POST", "../api/businesses/cusTomer", JSON.stringify(customerParse), postSuccess, postError);
            }

            else {
                customerIn = JSON.parse(localStorage.getItem("loggedIn"));
                customerIn.Chlist = customerHighlight;
                customerIn.PriceRange = selectedRadio;
                console.log(customerIn);
                ajaxCall("PUT", "../api/businesses/", JSON.stringify(customerIn), putSuccess, putError);
            }
        }
        function putSuccess(data) {
            console.log(data);
            localStorage.setItem("loggedIn", JSON.stringify(data));
            swal("Your Preferences was been updated", "", "success").then(function () { window.location.href = 'Favorites.html' });
        }
        function putError(err) {
            console.log(err);
        }
        function postSuccess(data) {
            console.log(data);
            localStorage.setItem("loggedIn", JSON.stringify(data));
            swal("Hi "+data.Name+"! Your Details Added Successfuly!", "Thank you :)", "success").then(function () { window.location.href = 'Favorites.html' });
        }

        function postError(err) {
            console.log(err);
            swal("Connection to server are failed :(", "Please Try Again", "danger");
        }
        function radioPrice(rb) {
            selectedRadio = rb.id;
        }

    </script>
        </head >
            <body>
                <div id="backbtn"></div>

                <div>
                    <h2>Select your Preferences</h2>
                    <div id="highlightsDIV"></div>
                    <br />
                    <div id="prUpdate"></div>
                    <br />
                    <input class="myButton" type="button" value="Submit" onclick="btnPostHighlight()" />
                </div>
            </body>
</html >
